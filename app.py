import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
import pandas as pd
import base64


# --- 1. í°íŠ¸ ì„¤ì • ---
def add_custom_font(font_file):
    with open(font_file, "rb") as f:
        data = f.read()
    b64_font = base64.b64encode(data).decode()
    st.markdown(f"""
        <style>
            @font-face {{ font-family: 'NanumGothic'; src: url(data:font/ttf;base64,{b64_font}) format('truetype'); }}
            html, body, [class*="css"] {{ font-family: 'NanumGothic', sans-serif; }}
        </style>
    """, unsafe_allow_html=True)

add_custom_font("NanumGothic.ttf")


# --- 2. êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° í•¨ìˆ˜ ---
def get_gspread_client():
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    # Secretsì—ì„œ ê³„ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    credentials = Credentials.from_service_account_info(st.secrets["gcp_service_account"], scopes=scopes)
    return gspread.authorize(credentials)


# 1. ì‚¬ì´ë“œë°” êµ¬ì„± (ë©”ë‰´ ì„ íƒ)
st.sidebar.title("ğŸ’ì‹ ìœ ì¼ì£¼;ì¥ì¸ì •ì‹ ")
st.sidebar.markdown("---")

# ë²„íŠ¼ ë””ìì¸ ëŒ€ì‹  ë¼ë””ì˜¤ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ íƒ­ ì´ë™ êµ¬í˜„ (ê°€ì¥ ì˜¤ë¥˜ê°€ ì ì€ ë°©ì‹ì…ë‹ˆë‹¤)
# 'label_visibility="hidden"'ìœ¼ë¡œ ë¼ë””ì˜¤ ë²„íŠ¼ ê¸€ìë§Œ ê¹”ë”í•˜ê²Œ ë³´ì´ê²Œ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
menu = st.sidebar.radio("ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”", ["ğŸ§˜â€â™€ï¸Mind", "ğŸ”¥Task", "ğŸ§ Brain","ğŸš¨ê¸´ê¸‰"])

st.sidebar.markdown("---")
st.sidebar.write("ì‹œê°„ì„ ê³µë°±ì„ ê²¬ëŒë‚´ì. .âœ¨")


# 2. ë©”ì¸ í™”ë©´ êµ¬ì„±

# === [Mind] íƒ­ ===
if menu == "ğŸ§˜â€â™€ï¸Mind":
    st.markdown("""
    <div style="text-align: center;">
        <h1 style="margin-bottom: 0;">ğŸŒ¿ ì¼ìƒ ì§€í‚¤ê¸°</h1>
        <p style="color: gray;">ğŸ‘ğŸ‘ì! ì™¸ìš°ì„¸ìš” â­â­</p>
    </div>
    """, unsafe_allow_html=True)
    
    
    st.info("ëŠ¦ì€ ì‹œì‘ì€ ìˆì–´ë„ ë§ì¹œ í•˜ë£¨ëŠ” ì—†ë‹¤.")
    st.info("í• ê¹Œë§ê¹Œ ê³ ë¯¼í•˜ëŠ” ìˆœê°„, í•´ë§ˆëŠ” ìª¼ê·¸ë¼ë“ ë‹¤.")
    with st.expander("â–¼ í•´ë§ˆê°€ ìª¼ê·¸ë¼ë“¤ë©´? (í´ë¦­)"):
        st.markdown("""
        - í•´ë§ˆê°€ ìª¼ê·¸ë¼ë“¤ë©´ ë¯¸ë˜ì˜ ë‚˜ë¥¼ ìƒìƒí•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.
        - ë¯¸ë˜ê°€ ì•ˆ ê·¸ë ¤ì§€ë‹ˆ ë™ê¸°ë¶€ì—¬ê°€ ì‚¬ë¼ì§€ê³ , ê²°êµ­ ì•„ë¬´ê²ƒë„ í•˜ê¸° ì‹«ì–´ì§‘ë‹ˆë‹¤.
        - ì˜¤ëŠ˜ í•˜ë£¨ë¼ë„ ë£¨í‹´ì„ ì§€í‚¤ë©´ í•´ë§ˆê°€ ë‹¤ì‹œ ì»¤ì§‘ë‹ˆë‹¤.
        """)
    st.info("ì‹œìŠ¤í…œ ê°€ë™ = ì—ì½”ëª¨ë“œ")
    with st.expander("â–¼ ğŸŸ¢ì—ì½”ëª¨ë“œë€? (í´ë¦­)"):
        st.markdown("""
        - ìƒíƒœ: ì•ˆì •ì  ì£¼í–‰ ì¤‘ ğŸš—
        - ì„¤ëª…: ë¶ˆí•„ìš”í•œ ê°ì • ì†Œëª¨ëŠ” ì°¨ë‹¨í•˜ê³ , ê¼­ í•„ìš”í•œ ë£¨í‹´ê³¼ ì—…ë¬´ì—ë§Œ ì—ë„ˆì§€ë¥¼ ì§‘ì¤‘í•˜ê³  ìˆìŒ
        - ëª©í‘œ: ë°©ì „ğŸª«ì—†ì´ ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê¸°ë¶„ ì¢‹ê²Œ ì™„ì£¼í•˜ê¸°.â›³
        """)
    st.divider()
    
    # --- 21ì¼ íŠ¸ë˜ì»¤ ê³„ì‚° ë¡œì§ ---
    try:
        # êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²°
        client = get_gspread_client()
        sh = client.open("task_21Tracker")
        worksheet = sh.get_worksheet(0)
        
        # ì €ì¥ëœ ì „ì²´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì²« ì¤„ ì œëª© ì œì™¸)
        all_records = worksheet.get_all_values()
        completed_days = len(all_records) - 1 if len(all_records) > 0 else 0
        
        # ëª©í‘œ ì„¤ì •: 21ì¼
        target_days = 21
        progress_val = min(completed_days / target_days, 1.0) # 100% ë„˜ì§€ ì•Šê²Œ ì„¤ì •
        
        # íŠ¸ë˜ì»¤ UI í‘œì‹œ
        st.markdown(f"### ğŸ”‹ 21ì¼ ë£¨í‹´ íŠ¸ë˜ì»¤")
        
        # ì§„í–‰ ë°” (ê²Œì´ì§€)
        st.progress(progress_val)
        
        # í˜„ì¬ í˜„í™© í…ìŠ¤íŠ¸
        col1, col2 = st.columns(2)
        with col1:
            st.metric("í˜„ì¬ ë‹¬ì„±", f"{completed_days}ì¼ì°¨")
        with col2:
            st.metric("ë‚¨ì€ ëª©í‘œ", f"{max(0, target_days - completed_days)}ì¼")
            
        st.write(f"ğŸƒ ì‹œìŠ¤í…œ1ì´ ìë™ìœ¼ë¡œ ì‘ë™í•  ë•Œê¹Œì§€ **{int(progress_val * 100)}%** ë‹¬ë ¤ì™”ìŠµë‹ˆë‹¤!")

    except Exception as e:
        st.error(f"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ì‹œíŠ¸ ê³µìœ  ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸ˜­")
        completed_days = 0

    st.divider()
    
    # í¼ì¹˜ê³  ì ‘ëŠ” ê¸°ëŠ¥ (Expander)
    with st.expander("â–¼ ì—°ì• í•˜ê³  ì‹¶ë‹¤ë©´ ... ? (í´ë¦­)"):
        st.markdown("""
        - **ë‚˜ë§Œì˜ ì†ë„ë¡œ ì”©ì”©í•˜ê²Œ ê±¸ì–´ê°€ì**
        - ë‚˜ë¥¼ ì§€í‚¬ ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ **ë‚˜ë°–ì— ì—†ë‹¤.**
        - ìƒí˜¸ìê·¹ & ì„œë¡œì˜ í˜ì´ìŠ¤ë©”ì´ì»¤ ë˜ê¸°
        - ë¶ˆì•ˆí•˜ê²Œ í•˜ì§€ ì•Šê³ , ë‘˜ì´ ìˆì„ ë•Œ ë‚˜ë‹¤ì›Œì§ˆ ìˆ˜ ìˆëŠ” ë‚¨ì
        - ì”ì†Œë¦¬ë¥¼ ë¶€ë¥´ì§€ ì•ŠëŠ” ë‚¨ì
        """)

# === [Task] íƒ­ ===
elif menu == "ğŸ”¥Task":
    st.title("âœ”ï¸ì¶œê·¼ë„ì¥ ì°ê¸° = ìƒí’ˆ 1ê°œ")
    
    st.warning("ì–´ë–¤ ì¼ì´ ìˆì–´ë„ ì˜¤ì „ 9ì‹œ 30ë¶„ì—ëŠ” ì»¤í”¼ ë‚´ë¦¬ê³  ì±…ìƒì— ì•‰ëŠ”ë‹¤.")
    
    st.markdown("""
    > **ì‚¬ì¥ì´ ì¶œê·¼ ì•ˆ í•˜ëŠ” íšŒì‚¬ëŠ” ë§í•¨** > **ì¶œê·¼í•˜ë©´ ì›”ê¸‰ë£¨íŒ¡ ëª¨ë“œ ê°€ëŠ¥!**
    """)
    
    st.write("")
    st.write("ì§€ê¸ˆ ë§‰ í™€ë¡œì„œê¸°ë¥¼ ì‹œì‘í–ˆë‹¤. ì„±ê³¼ì— ëŒ€í•œ ì¡°ê¸‰í•¨ì„ ë‚´ë ¤ë†“ì.")
    st.write("ì¼ì • í•œ ë¦¬ë“¬ì˜ ë°€ë„ë¥¼ íšŒë³µí•˜ëŠ” ê²ƒì´ ë¨¼ì €.")
    
    st.divider()
    
    st.subheader("1ë‹¨ê³„, ì„ê³„ì¹˜ë¥¼ ë„˜ê¸¸ ë•Œê¹Œì§€ ë£¨í‹´ ì‚¬ìˆ˜ (21ì¼)")
    st.write("- ì•„ì¹¨ìš´ë™ + ì˜¤ì „ì—…ë¬´ + ì˜¤í›„ì½”ë”© + ì €ë…ìš´ë™")
    st.write("- ì˜¤ì „ 3-4ì‹œê°„ì´ ìµœì„  -> ë¬´ë¦¬í•´ì„œ 8-10ì‹œê°„ ëŠ˜ë¦¬ë©´ ë²ˆì•„ì›ƒ ì˜¨ë‹¤..")
    
    st.success("ê²¨ìš° ì´ê²ƒë°–ì— ì•ˆ í•´? ë¼ëŠ” ë¶ˆì•ˆê°ì´ ë“¤ ë•Œê°€ ë°”ë¡œ ì„±ê³µì ìœ¼ë¡œ ì˜ˆì—´ë˜ê³  ìˆë‹¤ëŠ” ì¦ê±°!")
    
    if st.button("ì˜¤ëŠ˜ì˜ ì¶œê·¼ ë„ì¥ ì¾…! ğŸ’¾"):
        try:
            client = get_gspread_client()
            sh = client.open("task_21Tracker") 
            worksheet = sh.get_worksheet(0)
            
            # 1. ë‚ ì§œ ìƒì„±
            now = pd.Timestamp.now(tz='Asia/Seoul').strftime('%Y-%m-%d %H:%M')
            
            # 2. ì €ì¥í•  ë°ì´í„° (ì´ì œ score, memo ëŒ€ì‹  ê°„ë‹¨í•˜ê²Œ ê¸°ë¡!)
            # [ë‚ ì§œ, í™œë™ëª…] ì´ë ‡ê²Œ ë‘ ì¹¸ë§Œ ì±„ì›Œì„œ ì €ì¥í• ê²Œìš”.
            new_row = [now, "ìƒí’ˆ 1ê°œ ë“±ë¡ ì™„ë£Œ"] 
            
            # 3. ì‹œíŠ¸ì— ì¶”ê°€
            worksheet.append_row(new_row)
            
            st.success(f"ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ({now})")
            st.balloons() # ì¶•í•˜ í’ì„ ! ğŸˆ
            
            # ì €ì¥ ì§í›„ Mind íƒ­ì˜ ê²Œì´ì§€ë„ ë°”ë¡œ ë°”ë€Œê²Œ ìƒˆë¡œê³ ì¹¨
            st.rerun() 
            
        except Exception as e:
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: {e}")

    st.divider()

    # ë‹«ì•„ë†“ê¸° ê¸°ëŠ¥
    with st.expander("â–½ (ë‹«ì•„ë†“ê¸°) - 2ë‹¨ê³„/3ë‹¨ê³„ ê³„íš ë³´ê¸°"):
        st.markdown("""
        **2ë‹¨ê³„, ì„±ê³¼ê°€ ìˆ˜ì¹˜ë¡œ ë³´ì¼ ë•Œ ìì—°ìŠ¤ëŸ½ê²Œ í™•ì¥**
        - 1ë‹¨ê³„ ì—…ë¬´ëŸ‰ì´ ë„ˆë¬´ ì‰¬ì›Œì ¸ì„œ 30ë¶„ ì•ˆì— ëë‚  ë•Œ
        - ìƒí’ˆ 1ê°œ -> 5~10ê°œ í•œ ê·¸ë£¹ìœ¼ë¡œ í™•ì¥
        
        **3ë‹¨ê³„, ì˜¤ì „ì—…ë¬´-ì˜¤í›„ìê¸°ê³„ë°œ-ì €ë…ìš´ë™ ë°¸ëŸ°ìŠ¤ ìœ ì§€**
        - ì§ì¥ì¸ì²˜ëŸ¼ 9-6ë¥¼ ê³ ì§‘í•œë‹¤ê³  ì‚¬ì—…ì´ ì˜ë˜ëŠ” ê²ƒì´ ì•„ë‹˜
        - ì‹œìŠ¤í…œ1ì´ ìë™ìœ¼ë¡œ ì‘ë™í•´ ë°ì´í„°ê°€ ìŒ“ì´ëŠ” êµ¬ì¡°ë¥¼ ë§Œë“œëŠ” ê²ƒì´ ë” ì¤‘ìš”
        """)

# === [Brain] íƒ­ ===
elif menu == "ğŸ§ Brain":
    st.title("ë‡Œ ë°°í„°ë¦¬ ê´€ë¦¬ ë§¤ë‰´ì–¼")
    st.markdown("ë‚˜ì˜ ì˜ì§€ë ¥ì´ ë¶€ì¡±í•œ ê²Œ ì•„ë‹™ë‹ˆë‹¤. **ê³¼í•™ì ì¸ 'ì—ë„ˆì§€ ê³ ê°ˆ'** ìƒíƒœì…ë‹ˆë‹¤.")
    
    st.divider()

    # 1. ì›ì¸ ë¶„ì„ (System 2ì˜ íŒŒì—…) - ê²½ê³  ëŠë‚Œì˜ ë¶‰ì€ìƒ‰/ë…¸ë€ìƒ‰
    st.subheader("ğŸš¨ 1. ì™œ ì•„ë¬´ê²ƒë„ í•˜ê¸° ì‹«ì„ê¹Œ?")
    with st.expander("ì›ì¸ ë¶„ì„: ì‹œìŠ¤í…œ 2ì˜ íŒŒì—…ê³¼ ë„íŒŒë¯¼ ì €í•˜ (Click)", expanded=True):
        st.markdown("""
        * **ğŸ”‹ ì „ë‘ì—½ ë°©ì „ (System 2 íŒŒì—…):** * 'ë°˜ì¶”(ê³¼ê±° ìƒê°)'ì™€ 'ê²°ì •("ë­ ë¨¹ì§€?")'ì´ ì—ë„ˆì§€ë¥¼ ë‹¤ ì¨ë²„ë ¸ìŠµë‹ˆë‹¤.
            * ì •ì‘ ë‚˜ë¥¼ ëŒë³¼ ì—ë„ˆì§€ê°€ ë‚¨ì•„ìˆì§€ ì•Šì€ ìƒíƒœì˜ˆìš”.
        * **ğŸ“‰ ë„íŒŒë¯¼ íšŒë¡œ ê³ ì¥:**
            * ë§Œì„± ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ ë³´ìƒ ì²´ê³„ê°€ ë§ˆë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. 
            * "í•´ë´¤ì ë­í•´?"ë¼ëŠ” ìƒê°ì€ ë‡Œê°€ ì§€ì³¤ë‹¤ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤.
        * **ğŸ˜¶ ë¯¸ë˜ê°€ ì•ˆ ê·¸ë ¤ì§ (í•´ë§ˆ ê¸°ëŠ¥ ì €í•˜):**
            * í•´ë§ˆê°€ ì§€ì³ì„œ 'ê±´ê°•í•´ì§„ ë‚´ ëª¨ìŠµ'ì„ ìƒìƒí•  ìˆ˜ ì—†ìœ¼ë‹ˆ ë™ê¸°ë¶€ì—¬ê°€ ì•ˆ ë©ë‹ˆë‹¤.
        """)

    # 2. í•´ê²°ì±… (ì¶©ì „ ì „ëµ) - ê¸ì •ì ì¸ ì´ˆë¡ìƒ‰/íŒŒë€ìƒ‰
    st.subheader("âš¡ 2. ì–´ë–»ê²Œ ì¶©ì „í•´ì•¼ í• ê¹Œ?")
    with st.expander("ì²˜ë°©ì „: ì‹œìŠ¤í…œ 1ìœ¼ë¡œ ë²„í‹°ê¸° (Click)", expanded=True):
        st.markdown("""
        * **ğŸ¤– ë¡œë´‡ ëª¨ë“œ (System 1 ê°€ë™):** * "ê°ˆê¹Œ ë§ê¹Œ?" ê³ ë¯¼í•  ì—ë„ˆì§€ë¥¼ ì•„ë¼ì„¸ìš”.
            * ì•„ë¬´ ìƒê° ì—†ì´ ìˆ˜í–‰í•˜ëŠ” ë£¨í‹´ì´ ë‡Œë¥¼ ì‰¬ê²Œ í•©ë‹ˆë‹¤.
        * **ğŸ’¤ ìˆ˜ë©´ = ë‡Œ ì²­ì†Œ ì‹œê°„:**
            * ì‹œìŠ¤í…œ 1ë¡œ ì—ë„ˆì§€ë¥¼ ì•„ê»´ì•¼ ë°¤ì— ê¹Šì€ ì ì„ ì¡ë‹ˆë‹¤.
            * ì´ë•Œ ì „ì „ë‘ì—½ì˜ ë…¸íë¬¼ì´ ì”»ê²¨ ë‚˜ê°€ê³  í•´ë§ˆê°€ ì¬ìƒë©ë‹ˆë‹¤.
        * **ğŸ”‹ ì˜ì§€ë ¥ì˜ ê·€í™˜:**
            * ì¶©ë¶„íˆ ì¶©ì „ë˜ë©´ ìì—°ìŠ¤ëŸ½ê²Œ *"ì½”ë”© ì¢€ í•´ë³¼ê¹Œ?"* í•˜ëŠ” ì˜ìš•(ì‹œìŠ¤í…œ 2)ì´ ëŒì•„ì˜µë‹ˆë‹¤.
        """)

    st.divider()

    # 3. í•µì‹¬ ìš”ì•½ (Action Plan)
    st.info("ğŸ’¡ **ë‹¤í˜œ ë‹˜ì„ ìœ„í•œ 'ì €ì „ë ¥ ëª¨ë“œ' í–‰ë™ ê°•ë ¹**")
    st.markdown("""
    1.  **ì² ì €í•œ ê¸°ê³„ ìƒí™œ:** ê°ì •ì„ ì„ì§€ ë§ê³  ì…ë ¥ëœ ë£¨í‹´ëŒ€ë¡œë§Œ ì›€ì§ì´ì„¸ìš”.
    2.  **ì½”ë”©ì€ 'ë§›ë³´ê¸°'ë§Œ:** ë°°í„°ë¦¬ê°€ 1ì¹¸ë¿ì…ë‹ˆë‹¤. ë¬´ë¦¬í•˜ì§€ ë§ê³  ë”± 2ì‹œê°„ë§Œ!
    3.  **ì£„ì±…ê° ê¸ˆì§€:** ì§€ê¸ˆ ì‰¬ëŠ” ê±´ ê²Œìœ¼ë¦„ì´ ì•„ë‹ˆë¼ **'ê¸‰ì† ì¶©ì „ ì¤‘'**ì…ë‹ˆë‹¤.
    """)
    
    # === [ê¸´ê¸‰] íƒ­ ===
elif menu == "ğŸš¨ê¸´ê¸‰":
    
    st.warning("â‰ï¸ê°‘ìê¸° ì˜ìš•ì´ ë–¨ì–´ì§ˆë•Œ")
    
    st.markdown("""
    > **(ë‹µë³€)**
    """)
    st.divider()
    
    st.warning("â‰ï¸ë¶ˆì‘¥ ì˜›ìƒê°(ê°ì •ì ..)ì— ë¹ ì§€ë ¤ê³  í• ë•Œ")
    
    st.markdown("""
    > **(ë‹µë³€)**
    """)
    st.divider()
    

    